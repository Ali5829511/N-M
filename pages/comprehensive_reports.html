<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„Ø© - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø³ÙƒØ§Ù†</title>
    <link rel="stylesheet" href="../css/responsive-style.css">
    <link rel="stylesheet" href="../css/print-template.css">
    <style>
        .reports-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .report-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .report-header h1 {
            margin: 0 0 10px 0;
            font-size: 2.5em;
        }

        .report-header p {
            margin: 0;
            opacity: 0.9;
        }

        .report-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .report-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .report-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: #667eea;
        }

        .report-card.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        .report-card-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .report-card-title {
            font-size: 1.4em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .report-card-desc {
            color: #666;
            font-size: 0.95em;
        }

        .report-options {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .option-group {
            margin-bottom: 25px;
        }

        .option-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .option-group select,
        .option-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .option-group select:focus,
        .option-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin-left: 10px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 30px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .report-preview {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-top: 30px;
            display: none;
        }

        .report-preview.active {
            display: block;
        }

        .preview-header {
            border-bottom: 3px solid #667eea;
            padding-bottom: 15px;
            margin-bottom: 25px;
        }

        .preview-header h2 {
            margin: 0;
            color: #333;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.95em;
            opacity: 0.9;
        }

        /* Print styles are now in print-template.css */

        @media (max-width: 768px) {
            .report-header h1 {
                font-size: 1.8em;
            }

            .report-types {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="reports-container">
        <div class="report-header">
            <h1>ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„Ø©</h1>
            <p>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø¥Ø³ÙƒØ§Ù† Ø£Ø¹Ø¶Ø§Ø¡ Ù‡ÙŠØ¦Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ³ - ØªÙ‚Ø§Ø±ÙŠØ± Ù…ØªÙ‚Ø¯Ù…Ø© ÙˆÙ…ÙØµÙ„Ø©</p>
            <p id="reportDate"></p>
        </div>

        <div class="report-types">
            <div class="report-card" data-report="stickers">
                <div class="report-card-icon">ğŸš—</div>
                <div class="report-card-title">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù„ØµÙ‚Ø§Øª</div>
                <div class="report-card-desc">ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„ Ø¹Ù† Ù…Ù„ØµÙ‚Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª ÙˆØ§Ù„Ù…Ø±ÙƒØ¨Ø§Øª</div>
            </div>

            <div class="report-card" data-report="housing">
                <div class="report-card-icon">ğŸ </div>
                <div class="report-card-title">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥Ø³ÙƒØ§Ù†</div>
                <div class="report-card-desc">ØªÙ‚Ø±ÙŠØ± Ø¹Ù† Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø³ÙƒÙ†ÙŠØ© ÙˆØ§Ù„Ø¥Ø´ØºØ§Ù„</div>
            </div>

            <div class="report-card" data-report="residents">
                <div class="report-card-icon">ğŸ‘¥</div>
                <div class="report-card-title">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³ÙƒØ§Ù†</div>
                <div class="report-card-desc">ØªÙ‚Ø±ÙŠØ± Ø¹Ù† Ø£Ø¹Ø¶Ø§Ø¡ Ù‡ÙŠØ¦Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ³ ÙˆØ§Ù„Ø³ÙƒØ§Ù†</div>
            </div>

            <div class="report-card" data-report="violations">
                <div class="report-card-icon">âš ï¸</div>
                <div class="report-card-title">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª</div>
                <div class="report-card-desc">ØªÙ‚Ø±ÙŠØ± Ø¹Ù† Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª ÙˆØ§Ù„ØªØ¬Ø§ÙˆØ²Ø§Øª</div>
            </div>

            <div class="report-card" data-report="statistics">
                <div class="report-card-icon">ğŸ“ˆ</div>
                <div class="report-card-title">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠ</div>
                <div class="report-card-desc">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø´Ø§Ù…Ù„Ø© ÙˆØ±Ø³ÙˆÙ… Ø¨ÙŠØ§Ù†ÙŠØ©</div>
            </div>

            <div class="report-card" data-report="comprehensive">
                <div class="report-card-icon">ğŸ“‹</div>
                <div class="report-card-title">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„</div>
                <div class="report-card-desc">ØªÙ‚Ø±ÙŠØ± ÙƒØ§Ù…Ù„ ÙŠØ´Ù…Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</div>
            </div>
        </div>

        <div class="report-options">
            <h2>âš™ï¸ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ±</h2>
            
            <div class="option-group">
                <label>Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±:</label>
                <select id="reportType">
                    <option value="summary">Ù…Ù„Ø®Øµ</option>
                    <option value="detailed">Ù…ÙØµÙ„</option>
                    <option value="full">ÙƒØ§Ù…Ù„</option>
                </select>
            </div>

            <div class="option-group">
                <label>Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©:</label>
                <select id="timePeriod">
                    <option value="today">Ø§Ù„ÙŠÙˆÙ…</option>
                    <option value="week">Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</option>
                    <option value="month">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</option>
                    <option value="quarter">Ù‡Ø°Ø§ Ø§Ù„Ø±Ø¨Ø¹</option>
                    <option value="year">Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø§Ù…</option>
                    <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØªØ±Ø§Øª</option>
                    <option value="custom">ÙØªØ±Ø© Ù…Ø®ØµØµØ©</option>
                </select>
            </div>

            <div class="option-group" id="customDateRange" style="display: none;">
                <label>Ù…Ù† ØªØ§Ø±ÙŠØ®:</label>
                <input type="date" id="startDate">
                <label style="margin-top: 10px;">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®:</label>
                <input type="date" id="endDate">
            </div>

            <div class="option-group">
                <label>Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</label>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="includeStats" checked>
                        <label for="includeStats">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="includeCharts" checked>
                        <label for="includeCharts">Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="includeTables" checked>
                        <label for="includeTables">Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="includeDetails" checked>
                        <label for="includeDetails">Ø§Ù„ØªÙØ§ØµÙŠÙ„</label>
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" onclick="generateReport()">
                    ğŸ“Š Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                </button>
                <button class="btn btn-success" onclick="exportExcel()">
                    ğŸ“— ØªØµØ¯ÙŠØ± Excel
                </button>
                <button class="btn btn-info" onclick="exportPDF()">
                    ğŸ“„ ØªØµØ¯ÙŠØ± PDF
                </button>
                <button class="btn btn-warning" onclick="printReport()">
                    ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©
                </button>
            </div>
        </div>

        <div class="report-preview" id="reportPreview">
            <div class="preview-header">
                <h2 id="previewTitle">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„</h2>
                <p id="previewSubtitle"></p>
            </div>

            <div class="stats-grid" id="statsGrid"></div>

            <div id="reportContent"></div>
        </div>
    </div>

    <script src="../js/crypto-utils.js"></script>
    <script src="../js/database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®
        document.getElementById('reportDate').textContent = `ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${new Date().toLocaleDateString('ar-SA')}`;

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
        document.querySelectorAll('.report-card').forEach(card => {
            card.addEventListener('click', function() {
                document.querySelectorAll('.report-card').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØµØµØ©
        document.getElementById('timePeriod').addEventListener('change', function() {
            const customRange = document.getElementById('customDateRange');
            if (this.value === 'custom') {
                customRange.style.display = 'block';
            } else {
                customRange.style.display = 'none';
            }
        });

        // Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
        function generateReport() {
            const selectedCard = document.querySelector('.report-card.active');
            if (!selectedCard) {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }

            const reportType = selectedCard.dataset.report;
            const preview = document.getElementById('reportPreview');
            const title = document.getElementById('previewTitle');
            const subtitle = document.getElementById('previewSubtitle');
            const statsGrid = document.getElementById('statsGrid');
            const content = document.getElementById('reportContent');

            // Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
            preview.classList.add('active');
            preview.scrollIntoView({ behavior: 'smooth' });

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
            title.textContent = selectedCard.querySelector('.report-card-title').textContent;
            subtitle.textContent = `ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙÙŠ: ${new Date().toLocaleString('ar-SA')}`;

            // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const stickers = JSON.parse(localStorage.getItem('stickers') || '[]');
            const stats = JSON.parse(localStorage.getItem('stickerStats') || '{}');

            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${stickers.length}</div>
                    <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù„ØµÙ‚Ø§Øª</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stickers.filter(s => s.status === 'ÙØ¹Ø§Ù„').length}</div>
                    <div class="stat-label">Ù…Ù„ØµÙ‚Ø§Øª ÙØ¹Ø§Ù„Ø©</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stickers.filter(s => s.status === 'Ù…Ù„ØºÙŠ').length}</div>
                    <div class="stat-label">Ù…Ù„ØµÙ‚Ø§Øª Ù…Ù„ØºÙŠØ©</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${new Set(stickers.map(s => s.building)).size}</div>
                    <div class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ</div>
                </div>
            `;

            // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
            let reportHTML = '';

            if (reportType === 'stickers' || reportType === 'comprehensive') {
                reportHTML += generateStickersReport(stickers);
            }

            if (reportType === 'housing' || reportType === 'comprehensive') {
                reportHTML += generateHousingReport(stickers);
            }

            if (reportType === 'residents' || reportType === 'comprehensive') {
                reportHTML += generateResidentsReport(stickers);
            }

            if (reportType === 'violations' || reportType === 'comprehensive') {
                reportHTML += generateViolationsReport(stickers);
            }

            if (reportType === 'statistics' || reportType === 'comprehensive') {
                reportHTML += generateStatisticsReport(stickers);
            }

            content.innerHTML = reportHTML;
        }

        // Ø¯ÙˆØ§Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
        function generateStickersReport(stickers) {
            let html = '<h3>ğŸ“‹ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù„ØµÙ‚Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</h3>';
            html += '<table style="width:100%; border-collapse: collapse; margin-top: 20px;">';
            html += '<thead><tr style="background: #667eea; color: white;">';
            html += '<th style="padding: 12px; border: 1px solid #ddd;">Ø±Ù‚Ù… Ø§Ù„Ù…Ù„ØµÙ‚</th>';
            html += '<th style="padding: 12px; border: 1px solid #ddd;">Ø§Ø³Ù… Ø§Ù„Ø³Ø§ÙƒÙ†</th>';
            html += '<th style="padding: 12px; border: 1px solid #ddd;">Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©</th>';
            html += '<th style="padding: 12px; border: 1px solid #ddd;">Ø§Ù„Ù…Ø¨Ù†Ù‰</th>';
            html += '<th style="padding: 12px; border: 1px solid #ddd;">Ø§Ù„Ø´Ù‚Ø©</th>';
            html += '<th style="padding: 12px; border: 1px solid #ddd;">Ø§Ù„Ø­Ø§Ù„Ø©</th>';
            html += '</tr></thead><tbody>';

            stickers.slice(0, 50).forEach((sticker, index) => {
                html += `<tr style="background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};">`;
                html += `<td style="padding: 10px; border: 1px solid #ddd;">${sticker.id}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #ddd;">${sticker.residentName}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #ddd;">${sticker.licensePlate}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #ddd;">${sticker.building}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #ddd;">${sticker.apartment}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #ddd;">${sticker.status}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            if (stickers.length > 50) {
                html += `<p style="margin-top: 15px; color: #666;">* Ø¹Ø±Ø¶ Ø£ÙˆÙ„ 50 Ø³Ø¬Ù„ Ù…Ù† Ø£ØµÙ„ ${stickers.length} Ø³Ø¬Ù„</p>`;
            }
            return html;
        }

        function generateHousingReport(stickers) {
            const buildings = {};
            stickers.forEach(s => {
                if (!buildings[s.building]) {
                    buildings[s.building] = { total: 0, occupied: new Set() };
                }
                buildings[s.building].total++;
                buildings[s.building].occupied.add(s.apartment);
            });

            let html = '<h3 style="margin-top: 40px;">ğŸ  ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥Ø³ÙƒØ§Ù†</h3>';
            html += '<table style="width:100%; border-collapse: collapse; margin-top: 20px;">';
            html += '<thead><tr style="background: #11998e; color: white;">';
            html += '<th style="padding: 12px; border: 1px solid #ddd;">Ø±Ù‚Ù… Ø§Ù„Ù…Ø¨Ù†Ù‰</th>';
            html += '<th style="padding: 12px; border: 1px solid #ddd;">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù„ØµÙ‚Ø§Øª</th>';
            html += '<th style="padding: 12px; border: 1px solid #ddd;">Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø´ØºÙˆÙ„Ø©</th>';
            html += '</tr></thead><tbody>';

            Object.keys(buildings).sort((a, b) => a - b).forEach((building, index) => {
                html += `<tr style="background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};">`;
                html += `<td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${building}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${buildings[building].total}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${buildings[building].occupied.size}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            return html;
        }

        function generateResidentsReport(stickers) {
            const residents = {};
            stickers.forEach(s => {
                if (!residents[s.residentName]) {
                    residents[s.residentName] = [];
                }
                residents[s.residentName].push(s);
            });

            let html = '<h3 style="margin-top: 40px;">ğŸ‘¥ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³ÙƒØ§Ù†</h3>';
            html += '<table style="width:100%; border-collapse: collapse; margin-top: 20px;">';
            html += '<thead><tr style="background: #4facfe; color: white;">';
            html += '<th style="padding: 12px; border: 1px solid #ddd;">Ø§Ø³Ù… Ø§Ù„Ø³Ø§ÙƒÙ†</th>';
            html += '<th style="padding: 12px; border: 1px solid #ddd;">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª</th>';
            html += '<th style="padding: 12px; border: 1px solid #ddd;">Ø§Ù„Ù…Ø¨Ù†Ù‰</th>';
            html += '<th style="padding: 12px; border: 1px solid #ddd;">Ø§Ù„Ø´Ù‚Ø©</th>';
            html += '</tr></thead><tbody>';

            Object.keys(residents).slice(0, 50).forEach((name, index) => {
                const resident = residents[name][0];
                html += `<tr style="background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};">`;
                html += `<td style="padding: 10px; border: 1px solid #ddd;">${name}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${residents[name].length}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${resident.building}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${resident.apartment}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            return html;
        }

        function generateViolationsReport(stickers) {
            const violations = stickers.filter(s => s.status === 'Ù…Ù„ØºÙŠ' || s.status === 'Ù…Ø®Ø§Ù„Ù');

            let html = '<h3 style="margin-top: 40px;">âš ï¸ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª</h3>';
            
            if (violations.length === 0) {
                html += '<p style="color: #28a745; font-size: 1.2em; margin-top: 20px;">âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø®Ø§Ù„ÙØ§Øª Ù…Ø³Ø¬Ù„Ø©</p>';
            } else {
                html += '<table style="width:100%; border-collapse: collapse; margin-top: 20px;">';
                html += '<thead><tr style="background: #fa709a; color: white;">';
                html += '<th style="padding: 12px; border: 1px solid #ddd;">Ø±Ù‚Ù… Ø§Ù„Ù…Ù„ØµÙ‚</th>';
                html += '<th style="padding: 12px; border: 1px solid #ddd;">Ø§Ø³Ù… Ø§Ù„Ø³Ø§ÙƒÙ†</th>';
                html += '<th style="padding: 12px; border: 1px solid #ddd;">Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©</th>';
                html += '<th style="padding: 12px; border: 1px solid #ddd;">Ø§Ù„Ø­Ø§Ù„Ø©</th>';
                html += '</tr></thead><tbody>';

                violations.forEach((v, index) => {
                    html += `<tr style="background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};">`;
                    html += `<td style="padding: 10px; border: 1px solid #ddd;">${v.id}</td>`;
                    html += `<td style="padding: 10px; border: 1px solid #ddd;">${v.residentName}</td>`;
                    html += `<td style="padding: 10px; border: 1px solid #ddd;">${v.licensePlate}</td>`;
                    html += `<td style="padding: 10px; border: 1px solid #ddd;">${v.status}</td>`;
                    html += '</tr>';
                });

                html += '</tbody></table>';
            }

            return html;
        }

        function generateStatisticsReport(stickers) {
            const vehicleTypes = {};
            const buildingStats = {};

            stickers.forEach(s => {
                // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª
                const type = s.vehicleMake || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                vehicleTypes[type] = (vehicleTypes[type] || 0) + 1;

                // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ
                buildingStats[s.building] = (buildingStats[s.building] || 0) + 1;
            });

            let html = '<h3 style="margin-top: 40px;">ğŸ“ˆ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠ</h3>';
            
            // Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª Ø§Ù„Ø£ÙƒØ«Ø± Ø´ÙŠÙˆØ¹Ø§Ù‹
            html += '<h4 style="margin-top: 25px;">Ø£ÙƒØ«Ø± Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª Ø´ÙŠÙˆØ¹Ø§Ù‹:</h4>';
            html += '<table style="width:100%; border-collapse: collapse; margin-top: 15px;">';
            html += '<thead><tr style="background: #667eea; color: white;">';
            html += '<th style="padding: 12px; border: 1px solid #ddd;">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</th>';
            html += '<th style="padding: 12px; border: 1px solid #ddd;">Ø§Ù„Ø¹Ø¯Ø¯</th>';
            html += '<th style="padding: 12px; border: 1px solid #ddd;">Ø§Ù„Ù†Ø³Ø¨Ø©</th>';
            html += '</tr></thead><tbody>';

            const sortedTypes = Object.entries(vehicleTypes).sort((a, b) => b[1] - a[1]).slice(0, 10);
            sortedTypes.forEach(([type, count], index) => {
                const percentage = ((count / stickers.length) * 100).toFixed(1);
                html += `<tr style="background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};">`;
                html += `<td style="padding: 10px; border: 1px solid #ddd;">${type}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${count}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${percentage}%</td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';

            // Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ Ø§Ù„Ø£ÙƒØ«Ø± ÙƒØ«Ø§ÙØ©
            html += '<h4 style="margin-top: 30px;">Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ Ø§Ù„Ø£ÙƒØ«Ø± ÙƒØ«Ø§ÙØ©:</h4>';
            html += '<table style="width:100%; border-collapse: collapse; margin-top: 15px;">';
            html += '<thead><tr style="background: #11998e; color: white;">';
            html += '<th style="padding: 12px; border: 1px solid #ddd;">Ø±Ù‚Ù… Ø§Ù„Ù…Ø¨Ù†Ù‰</th>';
            html += '<th style="padding: 12px; border: 1px solid #ddd;">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù„ØµÙ‚Ø§Øª</th>';
            html += '</tr></thead><tbody>';

            const sortedBuildings = Object.entries(buildingStats).sort((a, b) => b[1] - a[1]).slice(0, 10);
            sortedBuildings.forEach(([building, count], index) => {
                html += `<tr style="background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};">`;
                html += `<td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${building}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${count}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';

            return html;
        }

        // Ø¯Ø§Ù„Ø© ØªØµØ¯ÙŠØ± Excel
        function exportExcel() {
            const stickers = JSON.parse(localStorage.getItem('stickers') || '[]');
            
            if (stickers.length === 0) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
                return;
            }

            const ws = XLSX.utils.json_to_sheet(stickers);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Ø§Ù„Ù…Ù„ØµÙ‚Ø§Øª');
            
            const fileName = `ØªÙ‚Ø±ÙŠØ±_Ø´Ø§Ù…Ù„_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        // Ø¯Ø§Ù„Ø© ØªØµØ¯ÙŠØ± PDF
        function exportPDF() {
            window.print();
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
        function printReport() {
            window.print();
        }
    </script>
    
    <script src="../js/print-template.js"></script>
    <script>
        // Initialize print template
        PrintTemplate.init({
            reportTitle: 'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„Ø©',
            reportSubtitle: 'Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø¥Ø³ÙƒØ§Ù† Ø£Ø¹Ø¶Ø§Ø¡ Ù‡ÙŠØ¦Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ³',
            showDate: true,
            showLogo: true
        });
        
        // Apply print preparation
        PrintTemplate.prepareTable('table');
        PrintTemplate.preventPageBreak('.report-section');
        PrintTemplate.preventPageBreak('.stat-card');
    </script>
</body>
</html>
