<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© ParkPow - Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ù„ÙˆØ­Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</title>
    <link rel="stylesheet" href="../css/responsive-style.css">
    <style>
        .parkpow-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }

        .status-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 8px;
        }

        .status-indicator.active {
            background: #28a745;
            box-shadow: 0 0 10px #28a745;
        }

        .status-indicator.inactive {
            background: #dc3545;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #000;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            margin: 0;
            font-size: 36px;
        }

        .stat-card p {
            margin: 10px 0 0 0;
            opacity: 0.9;
        }

        .log-container {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
            margin-top: 20px;
        }

        .log-entry {
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            background: white;
        }

        .log-entry.success {
            border-right: 4px solid #28a745;
        }

        .log-entry.error {
            border-right: 4px solid #dc3545;
        }

        .log-entry.info {
            border-right: 4px solid #17a2b8;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-modal {
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }

        .close-modal:hover {
            color: #333;
        }
    </style>
</head>
<body>
    <div class="parkpow-container">
        <h1>ğŸš— Ø¥Ø¯Ø§Ø±Ø© ParkPow - Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ù„ÙˆØ­Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</h1>

        <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­Ø§Ù„Ø© -->
        <div class="status-card">
            <h2>
                <span class="status-indicator" id="statusIndicator"></span>
                Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ ParkPow
            </h2>
            <p id="statusMessage">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„...</p>
            <div id="connectionDetails" style="margin-top: 15px; display: none;">
                <p><strong>Ø±Ø§Ø¨Ø· API:</strong> <span id="apiUrl"></span></p>
                <p><strong>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</strong> <span id="region"></span></p>
            </div>
        </div>

        <!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3 id="totalVehicles">0</h3>
                <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©</p>
            </div>
            <div class="stat-card">
                <h3 id="syncedVehicles">0</h3>
                <p>Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†Ø© Ù…Ø¹ ParkPow</p>
            </div>
            <div class="stat-card">
                <h3 id="pendingSync">0</h3>
                <p>ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</p>
            </div>
        </div>

        <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª -->
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="testConnection()">
                ğŸ”Œ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„
            </button>
            <button class="btn btn-success" onclick="syncAllVehicles()">
                ğŸ”„ Ù…Ø²Ø§Ù…Ù†Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª
            </button>
            <button class="btn btn-warning" onclick="viewSyncStatus()">
                ğŸ“Š Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
            </button>
            <button class="btn btn-primary" onclick="setupCameras()">
                ğŸ“¹ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª
            </button>
            <button class="btn btn-primary" onclick="viewVisits()">
                ğŸ“‹ Ø¹Ø±Ø¶ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª
            </button>
            <button class="btn btn-danger" onclick="goBack()">
                â† Ø§Ù„Ø¹ÙˆØ¯Ø©
            </button>
        </div>

        <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØµØ¯ÙŠØ± ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø© -->
        <div class="action-buttons" style="margin-top: 10px; border-top: 2px solid #eee; padding-top: 15px;">
            <button class="btn btn-success" onclick="exportToExcel()">
                ğŸ“Š ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel
            </button>
            <button class="btn btn-danger" onclick="exportToPDF()">
                ğŸ“„ ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ PDF
            </button>
            <button class="btn btn-primary" onclick="printReport()">
                ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©
            </button>
        </div>

        <!-- Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« -->
        <div class="status-card">
            <h2>ğŸ“ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</h2>
            <div class="log-container" id="logContainer">
                <div class="log-entry info">
                    <strong>[Ù…Ø¹Ù„ÙˆÙ…Ø§Øª]</strong> Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¨Ø¯Ø¡...
                </div>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ -->
    <div class="modal" id="detailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Ø§Ù„ØªÙØ§ØµÙŠÙ„</h2>
                <span class="close-modal" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <!-- Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„ØªØµØ¯ÙŠØ± ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø© -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <script src="../js/database.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/parkpow-integration.js"></script>
    <script>
        let syncResults = null;

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
        async function initPage() {
            await window.parkpowAPI.init();
            await checkConnection();
            updateStats();
            logMessage('info', 'ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø© Ø¨Ù†Ø¬Ø§Ø­');
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„
        async function checkConnection() {
            const result = await window.parkpowAPI.testConnection();
            const indicator = document.getElementById('statusIndicator');
            const message = document.getElementById('statusMessage');
            const details = document.getElementById('connectionDetails');

            if (result.success) {
                indicator.className = 'status-indicator active';
                message.textContent = result.message;
                message.style.color = '#28a745';
                
                // Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„
                details.style.display = 'block';
                document.getElementById('apiUrl').textContent = window.parkpowAPI.apiUrl;
                document.getElementById('region').textContent = window.parkpowAPI.region;
            } else {
                indicator.className = 'status-indicator inactive';
                message.textContent = result.message;
                message.style.color = '#dc3545';
                details.style.display = 'none';
            }
        }

        // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„
        async function testConnection() {
            logMessage('info', 'Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„...');
            await checkConnection();
            logMessage('success', 'ØªÙ… Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„');
        }

        // Ù…Ø²Ø§Ù…Ù†Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª
        async function syncAllVehicles() {
            if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø²Ø§Ù…Ù†Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª Ù…Ø¹ ParkPowØŸ\nÙ‚Ø¯ ØªØ³ØªØºØ±Ù‚ Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ø¹Ø¶ Ø§Ù„ÙˆÙ‚Øª.')) {
                return;
            }

            try {
                logMessage('info', 'Ø¨Ø¯Ø¡ Ù…Ø²Ø§Ù…Ù†Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª...');
                showLoading();

                syncResults = await window.parkpowAPI.syncAllVehicles();

                hideLoading();
                logMessage('success', `ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­! Ù†Ø¬Ø­: ${syncResults.success.length}, ÙØ´Ù„: ${syncResults.failed.length}`);

                // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                showSyncResults();
                updateStats();
            } catch (error) {
                hideLoading();
                logMessage('error', `Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: ${error.message}`);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: ' + error.message);
            }
        }

        // Ø¹Ø±Ø¶ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
        function showSyncResults() {
            if (!syncResults) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø²Ø§Ù…Ù†Ø©');
                return;
            }

            const modalBody = document.getElementById('modalBody');
            document.getElementById('modalTitle').textContent = 'Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©';

            let html = `
                <div style="margin-bottom: 20px;">
                    <h3>Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:</h3>
                    <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª: ${syncResults.total}</p>
                    <p style="color: #28a745;">Ù†Ø¬Ø­: ${syncResults.success.length}</p>
                    <p style="color: #dc3545;">ÙØ´Ù„: ${syncResults.failed.length}</p>
                </div>
            `;

            if (syncResults.failed.length > 0) {
                html += `
                    <div>
                        <h3>Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª Ø§Ù„ÙØ§Ø´Ù„Ø©:</h3>
                        <ul>
                `;
                syncResults.failed.forEach(item => {
                    html += `<li>${item.sticker.plateNumber || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}: ${item.error}</li>`;
                });
                html += `</ul></div>`;
            }

            modalBody.innerHTML = html;
            document.getElementById('detailsModal').classList.add('active');
        }

        // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
        function viewSyncStatus() {
            const stickers = JSON.parse(localStorage.getItem('stickers') || '[]');
            const synced = stickers.filter(s => s.parkpow_id).length;
            const pending = stickers.length - synced;

            const modalBody = document.getElementById('modalBody');
            document.getElementById('modalTitle').textContent = 'Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©';

            modalBody.innerHTML = `
                <div>
                    <h3>Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:</h3>
                    <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª: ${stickers.length}</p>
                    <p style="color: #28a745;">Ù…ØªØ²Ø§Ù…Ù†Ø©: ${synced}</p>
                    <p style="color: #ffc107;">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: ${pending}</p>
                </div>
                <div style="margin-top: 20px;">
                    <h3>Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†Ø©:</h3>
                    <ul>
                        ${stickers.filter(s => !s.parkpow_id).map(s => 
                            `<li>${s.plateNumber || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} - ${s.ownerName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</li>`
                        ).join('') || '<li>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª Ù…ØªØ²Ø§Ù…Ù†Ø© âœ“</li>'}
                    </ul>
                </div>
            `;

            document.getElementById('detailsModal').classList.add('active');
        }

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª
        async function setupCameras() {
            const modalBody = document.getElementById('modalBody');
            document.getElementById('modalTitle').textContent = 'Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª';

            modalBody.innerHTML = `
                <p>Ù‚Ø±ÙŠØ¨Ø§Ù‹: ÙˆØ§Ø¬Ù‡Ø© Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª</p>
                <p>ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø§Ù„ÙŠØ§Ù‹ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø¹Ø¨Ø± API</p>
            `;

            document.getElementById('detailsModal').classList.add('active');
        }

        // Ø¹Ø±Ø¶ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª
        async function viewVisits() {
            try {
                logMessage('info', 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª...');
                showLoading();

                const visits = await window.parkpowAPI.getVisits({ limit: 10 });

                hideLoading();
                logMessage('success', 'ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª');

                const modalBody = document.getElementById('modalBody');
                document.getElementById('modalTitle').textContent = 'Ø¢Ø®Ø± Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª';

                if (visits.results && visits.results.length > 0) {
                    modalBody.innerHTML = `
                        <ul>
                            ${visits.results.map(v => `
                                <li>
                                    <strong>${v.license_plate || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</strong><br>
                                    Ø§Ù„ÙˆÙ‚Øª: ${new Date(v.timestamp).toLocaleString('ar-SA')}<br>
                                    Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: ${v.camera || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
                                </li>
                            `).join('')}
                        </ul>
                    `;
                } else {
                    modalBody.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª Ù…Ø³Ø¬Ù„Ø©</p>';
                }

                document.getElementById('detailsModal').classList.add('active');
            } catch (error) {
                hideLoading();
                logMessage('error', `Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª: ${error.message}`);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª: ' + error.message);
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        function updateStats() {
            const stickers = JSON.parse(localStorage.getItem('stickers') || '[]');
            const synced = stickers.filter(s => s.parkpow_id).length;
            const pending = stickers.length - synced;

            document.getElementById('totalVehicles').textContent = stickers.length;
            document.getElementById('syncedVehicles').textContent = synced;
            document.getElementById('pendingSync').textContent = pending;
        }

        // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„
        function logMessage(type, message) {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString('ar-SA');
            
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            
            let icon = 'ğŸ“';
            if (type === 'success') icon = 'âœ“';
            if (type === 'error') icon = 'âœ—';
            if (type === 'info') icon = 'â„¹';
            
            entry.innerHTML = `<strong>[${timestamp}] ${icon}</strong> ${message}`;
            
            logContainer.insertBefore(entry, logContainer.firstChild);
            
            // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 50 Ø±Ø³Ø§Ù„Ø©
            while (logContainer.children.length > 50) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
        function closeModal() {
            document.getElementById('detailsModal').classList.remove('active');
        }

        // Ø¹Ø±Ø¶ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        function showLoading() {
            // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø´Ø± ØªØ­Ù…ÙŠÙ„ Ø¹Ø§Ù… Ù‡Ù†Ø§
        }

        // Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        function hideLoading() {
            // ÙŠÙ…ÙƒÙ† Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù‡Ù†Ø§
        }

        // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        function goBack() {
            window.location.href = 'home.html';
        }

        // ==================== ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØµØ¯ÙŠØ± ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø© ====================

        // ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel
        async function exportToExcel() {
            try {
                logMessage('info', 'Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ù…Ù„Ù Excel...');
                
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const vehicles = window.db.getAllVehicles();
                const stats = {
                    total: vehicles.length,
                    synced: 0,
                    pending: vehicles.length
                };

                // ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±
                const data = vehicles.map((v, index) => ({
                    '#': index + 1,
                    'Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©': v.plateNumber || '',
                    'Ø§Ù„ØµØ§Ù†Ø¹': v.make || '',
                    'Ø§Ù„Ø·Ø±Ø§Ø²': v.model || '',
                    'Ø§Ù„Ù„ÙˆÙ†': v.color || '',
                    'Ø§Ù„Ù†ÙˆØ¹': v.type || '',
                    'Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ': v.ownerName || '',
                    'Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©': v.unitNumber || '',
                    'Ø±Ù‚Ù… Ø§Ù„Ù…Ù„ØµÙ‚': v.stickerNumber || '',
                    'Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©': v.idNumber || '',
                    'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„': v.phoneNumber || '',
                    'Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©': 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±'
                }));

                // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ±Ù‚Ø© Ø§Ù„Ø¹Ù…Ù„
                const ws = XLSX.utils.json_to_sheet(data);
                
                // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ø±Ø¶
                const colWidths = [
                    {wch: 5},  // #
                    {wch: 15}, // Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©
                    {wch: 12}, // Ø§Ù„ØµØ§Ù†Ø¹
                    {wch: 12}, // Ø§Ù„Ø·Ø±Ø§Ø²
                    {wch: 10}, // Ø§Ù„Ù„ÙˆÙ†
                    {wch: 10}, // Ø§Ù„Ù†ÙˆØ¹
                    {wch: 20}, // Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ
                    {wch: 12}, // Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©
                    {wch: 12}, // Ø±Ù‚Ù… Ø§Ù„Ù…Ù„ØµÙ‚
                    {wch: 15}, // Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©
                    {wch: 15}, // Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„
                    {wch: 15}  // Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
                ];
                ws['!cols'] = colWidths;

                // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ±Ù‚Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                const statsData = [
                    {'Ø§Ù„Ø¨ÙŠØ§Ù†': 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª', 'Ø§Ù„Ø¹Ø¯Ø¯': stats.total},
                    {'Ø§Ù„Ø¨ÙŠØ§Ù†': 'Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†Ø©', 'Ø§Ù„Ø¹Ø¯Ø¯': stats.synced},
                    {'Ø§Ù„Ø¨ÙŠØ§Ù†': 'ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©', 'Ø§Ù„Ø¹Ø¯Ø¯': stats.pending}
                ];
                const wsStats = XLSX.utils.json_to_sheet(statsData);
                wsStats['!cols'] = [{wch: 25}, {wch: 15}];

                // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØªØ§Ø¨ Ø§Ù„Ø¹Ù…Ù„
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, wsStats, 'Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª');
                XLSX.utils.book_append_sheet(wb, ws, 'Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª');

                // Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù
                const fileName = `ParkPow_Report_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                logMessage('success', `ØªÙ… ØªØµØ¯ÙŠØ± ${vehicles.length} Ù…Ø±ÙƒØ¨Ø© Ø¥Ù„Ù‰ Excel Ø¨Ù†Ø¬Ø§Ø­`);
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±:', error);
                logMessage('error', 'ÙØ´Ù„ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Excel');
            }
        }

        // ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ PDF
        async function exportToPDF() {
            try {
                logMessage('info', 'Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ù…Ù„Ù PDF...');
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: 'a4'
                });

                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®Ø· Ø§Ù„Ø¹Ø±Ø¨ÙŠ
                doc.setFont('helvetica');
                doc.setLanguage('ar');

                // Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
                doc.setFontSize(18);
                doc.text('ØªÙ‚Ø±ÙŠØ± Ù†Ø¸Ø§Ù… ParkPow - Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ù„ÙˆØ­Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª', 148, 20, { align: 'center' });
                
                doc.setFontSize(12);
                doc.text(`Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString('ar-SA')}`, 148, 28, { align: 'center' });

                // Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                const vehicles = window.db.getAllVehicles();
                const stats = {
                    total: vehicles.length,
                    synced: 0,
                    pending: vehicles.length
                };

                doc.setFontSize(14);
                doc.text('Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:', 270, 40, { align: 'right' });
                
                doc.setFontSize(11);
                doc.text(`Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª: ${stats.total}`, 270, 48, { align: 'right' });
                doc.text(`Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†Ø©: ${stats.synced}`, 270, 54, { align: 'right' });
                doc.text(`ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: ${stats.pending}`, 270, 60, { align: 'right' });

                // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª
                const tableData = vehicles.slice(0, 50).map((v, index) => [
                    index + 1,
                    v.plateNumber || '',
                    v.make || '',
                    v.model || '',
                    v.color || '',
                    v.ownerName || '',
                    v.unitNumber || '',
                    v.stickerNumber || ''
                ]);

                doc.autoTable({
                    startY: 70,
                    head: [['#', 'Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©', 'Ø§Ù„ØµØ§Ù†Ø¹', 'Ø§Ù„Ø·Ø±Ø§Ø²', 'Ø§Ù„Ù„ÙˆÙ†', 'Ø§Ù„Ù…Ø§Ù„Ùƒ', 'Ø§Ù„ÙˆØ­Ø¯Ø©', 'Ø§Ù„Ù…Ù„ØµÙ‚']],
                    body: tableData,
                    styles: {
                        font: 'helvetica',
                        fontSize: 9,
                        halign: 'center'
                    },
                    headStyles: {
                        fillColor: [41, 128, 185],
                        textColor: 255,
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [245, 245, 245]
                    },
                    margin: { top: 70, right: 10, left: 10 }
                });

                // Ù…Ù„Ø§Ø­Ø¸Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø§Ù„Ù…Ø²ÙŠØ¯
                if (vehicles.length > 50) {
                    const finalY = doc.lastAutoTable.finalY + 10;
                    doc.setFontSize(10);
                    doc.text(`Ù…Ù„Ø§Ø­Ø¸Ø©: ÙŠØ¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø£ÙˆÙ„ 50 Ù…Ø±ÙƒØ¨Ø© Ù…Ù† Ø£ØµÙ„ ${vehicles.length} Ù…Ø±ÙƒØ¨Ø©`, 148, finalY, { align: 'center' });
                }

                // Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù
                const fileName = `ParkPow_Report_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
                logMessage('success', 'ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¥Ù„Ù‰ PDF Ø¨Ù†Ø¬Ø§Ø­');
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±:', error);
                logMessage('error', 'ÙØ´Ù„ ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¥Ù„Ù‰ PDF');
            }
        }

        // Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± (Ø¨Ø¯ÙˆÙ† Ø±Ø£Ø³ ÙˆØªØ°ÙŠÙŠÙ„)
        function printReport() {
            try {
                logMessage('info', 'Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©...');
                
                const vehicles = window.db.getAllVehicles();
                const stats = {
                    total: vehicles.length,
                    synced: 0,
                    pending: vehicles.length
                };

                // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ø·Ø¨Ø§Ø¹Ø©
                const printWindow = window.open('', '_blank');
                
                // Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
                const printContent = `
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>ØªÙ‚Ø±ÙŠØ± ParkPow</title>
                    <style>
                        @page {
                            margin: 0;
                            size: A4 landscape;
                        }
                        @media print {
                            body {
                                margin: 0;
                                padding: 20mm;
                            }
                            header, footer {
                                display: none !important;
                            }
                        }
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        body {
                            font-family: 'Arial', sans-serif;
                            direction: rtl;
                            padding: 20mm;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 20px;
                            border-bottom: 3px solid #2c3e50;
                            padding-bottom: 15px;
                        }
                        .header h1 {
                            color: #2c3e50;
                            font-size: 24px;
                            margin-bottom: 10px;
                        }
                        .header p {
                            color: #7f8c8d;
                            font-size: 14px;
                        }
                        .stats {
                            display: flex;
                            justify-content: space-around;
                            margin: 20px 0;
                            padding: 15px;
                            background: #ecf0f1;
                            border-radius: 8px;
                        }
                        .stat-item {
                            text-align: center;
                        }
                        .stat-item h3 {
                            color: #2980b9;
                            font-size: 28px;
                            margin-bottom: 5px;
                        }
                        .stat-item p {
                            color: #34495e;
                            font-size: 14px;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 20px;
                            font-size: 11px;
                        }
                        th {
                            background: #2980b9;
                            color: white;
                            padding: 12px 8px;
                            text-align: center;
                            font-weight: bold;
                        }
                        td {
                            padding: 10px 8px;
                            text-align: center;
                            border-bottom: 1px solid #ddd;
                        }
                        tr:nth-child(even) {
                            background: #f8f9fa;
                        }
                        tr:hover {
                            background: #e8f4f8;
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>ğŸš— ØªÙ‚Ø±ÙŠØ± Ù†Ø¸Ø§Ù… ParkPow - Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ù„ÙˆØ­Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</h1>
                        <p>Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø¥Ù…Ø§Ù… Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø³Ø¹ÙˆØ¯ Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ© - ÙˆØ­Ø¯Ø© Ø¥Ø³ÙƒØ§Ù† Ù‡ÙŠØ¦Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ³</p>
                        <p>Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString('ar-SA')} | Ø§Ù„ÙˆÙ‚Øª: ${new Date().toLocaleTimeString('ar-SA')}</p>
                    </div>
                    
                    <div class="stats">
                        <div class="stat-item">
                            <h3>${stats.total}</h3>
                            <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª</p>
                        </div>
                        <div class="stat-item">
                            <h3>${stats.synced}</h3>
                            <p>Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†Ø©</p>
                        </div>
                        <div class="stat-item">
                            <h3>${stats.pending}</h3>
                            <p>ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</p>
                        </div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©</th>
                                <th>Ø§Ù„ØµØ§Ù†Ø¹</th>
                                <th>Ø§Ù„Ø·Ø±Ø§Ø²</th>
                                <th>Ø§Ù„Ù„ÙˆÙ†</th>
                                <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ</th>
                                <th>Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                                <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ù„ØµÙ‚</th>
                                <th>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</th>
                                <th>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${vehicles.map((v, index) => `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${v.plateNumber || '-'}</td>
                                    <td>${v.make || '-'}</td>
                                    <td>${v.model || '-'}</td>
                                    <td>${v.color || '-'}</td>
                                    <td>${v.type || '-'}</td>
                                    <td>${v.ownerName || '-'}</td>
                                    <td>${v.unitNumber || '-'}</td>
                                    <td>${v.stickerNumber || '-'}</td>
                                    <td>${v.idNumber || '-'}</td>
                                    <td>${v.phoneNumber || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
                `;
                
                printWindow.document.write(printContent);
                printWindow.document.close();
                
                // Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø«Ù… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
                printWindow.onload = function() {
                    printWindow.focus();
                    printWindow.print();
                };
                
                logMessage('success', 'ØªÙ… ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©');
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©:', error);
                logMessage('error', 'ÙØ´Ù„ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©');
            }
        }

        // ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>
