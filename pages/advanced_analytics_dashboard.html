<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±ÙˆØ±</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #8B6F47;
            --secondary-color: #003c50;
            --success-color: #51cf66;
            --warning-color: #ffa94d;
            --danger-color: #ff6b6b;
            --info-color: #339af0;
            --light-bg: #f8f9fa;
            --white: #ffffff;
            --text-dark: #2c3e50;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            direction: rtl;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: var(--white);
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: var(--primary-color);
            font-size: 28px;
            font-weight: 700;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: var(--primary-color);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: var(--white);
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .stat-card .icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin-bottom: 15px;
        }

        .stat-card.vehicles .icon {
            background: rgba(51, 154, 240, 0.1);
            color: var(--info-color);
        }

        .stat-card.violations .icon {
            background: rgba(255, 107, 107, 0.1);
            color: var(--danger-color);
        }

        .stat-card.repeated .icon {
            background: rgba(255, 169, 77, 0.1);
            color: var(--warning-color);
        }

        .stat-card.resolved .icon {
            background: rgba(81, 207, 102, 0.1);
            color: var(--success-color);
        }

        .stat-card h3 {
            color: var(--text-dark);
            font-size: 16px;
            margin-bottom: 10px;
        }

        .stat-card .number {
            font-size: 36px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .card {
            background: var(--white);
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--shadow);
        }

        .card h2 {
            color: var(--primary-color);
            font-size: 20px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light-bg);
        }

        .table-container {
            overflow-x: auto;
            margin-top: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table th {
            background: var(--light-bg);
            padding: 12px;
            text-align: right;
            font-weight: 600;
            color: var(--text-dark);
        }

        table td {
            padding: 12px;
            border-bottom: 1px solid var(--light-bg);
        }

        table tr:hover {
            background: var(--light-bg);
        }

        .badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-danger {
            background: rgba(255, 107, 107, 0.1);
            color: var(--danger-color);
        }

        .badge-warning {
            background: rgba(255, 169, 77, 0.1);
            color: var(--warning-color);
        }

        .badge-success {
            background: rgba(81, 207, 102, 0.1);
            color: var(--success-color);
        }

        .badge-info {
            background: rgba(51, 154, 240, 0.1);
            color: var(--info-color);
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid var(--light-bg);
            border-radius: 10px;
            font-family: 'Cairo', sans-serif;
            font-size: 16px;
            transition: border 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .chart-container {
            height: 300px;
            margin-top: 20px;
            background: var(--light-bg);
            border-radius: 10px;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: var(--primary-color);
        }

        .loading.active {
            display: block;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            .content-grid {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
        }

        .filter-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-controls select,
        .filter-controls input {
            padding: 10px;
            border: 2px solid var(--light-bg);
            border-radius: 8px;
            font-family: 'Cairo', sans-serif;
        }

        .violation-count {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 30px;
            height: 30px;
            background: var(--danger-color);
            color: white;
            border-radius: 50%;
            font-weight: bold;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1><i class="fas fa-chart-line"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</h1>
                <p style="color: #666; margin-top: 5px;">ØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª ÙˆØ§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª</p>
            </div>
            <a href="unified_dashboard.html" class="btn btn-primary">
                <i class="fas fa-home"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            </a>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card vehicles">
                <div class="icon"><i class="fas fa-car"></i></div>
                <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</h3>
                <div class="number" id="totalVehicles">0</div>
            </div>
            <div class="stat-card violations">
                <div class="icon"><i class="fas fa-exclamation-triangle"></i></div>
                <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª</h3>
                <div class="number" id="totalViolations">0</div>
            </div>
            <div class="stat-card repeated">
                <div class="icon"><i class="fas fa-redo"></i></div>
                <h3>Ø§Ù„Ù…Ø®Ø§Ù„ÙÙˆÙ† Ø§Ù„Ù…ØªÙƒØ±Ø±ÙˆÙ†</h3>
                <div class="number" id="repeatedOffenders">0</div>
            </div>
            <div class="stat-card resolved">
                <div class="icon"><i class="fas fa-check-circle"></i></div>
                <h3>Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ù…Ø­Ù„ÙˆÙ„Ø©</h3>
                <div class="number" id="resolvedViolations">0</div>
            </div>
        </div>

        <!-- Content Grid -->
        <div class="content-grid">
            <!-- Top Offenders -->
            <div class="card">
                <h2><i class="fas fa-trophy"></i> Ø£ÙƒØ«Ø± Ø§Ù„Ù…Ø®Ø§Ù„ÙÙŠÙ† ØªÙƒØ±Ø§Ø±Ø§Ù‹</h2>
                <div class="search-box">
                    <input type="text" id="searchOffenders" placeholder="ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø®Ø§Ù„Ù...">
                </div>
                <div class="table-container">
                    <table id="topOffendersTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©</th>
                                <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            </tr>
                        </thead>
                        <tbody id="topOffendersBody">
                            <tr>
                                <td colspan="4" class="empty-state">
                                    <i class="fas fa-database"></i>
                                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø©</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Recent Violations -->
            <div class="card">
                <h2><i class="fas fa-clock"></i> Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª</h2>
                <div class="filter-controls">
                    <select id="filterType">
                        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
                        <option value="ØªÙˆÙ‚Ù Ø®Ø§Ø·Ø¦">ØªÙˆÙ‚Ù Ø®Ø§Ø·Ø¦</option>
                        <option value="ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø³Ø±Ø¹Ø©">ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø³Ø±Ø¹Ø©</option>
                        <option value="Ø¹Ø¯Ù… Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ø¥Ø´Ø§Ø±Ø©">Ø¹Ø¯Ù… Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ø¥Ø´Ø§Ø±Ø©</option>
                    </select>
                    <input type="date" id="filterDate">
                </div>
                <div class="table-container">
                    <table id="recentViolationsTable">
                        <thead>
                            <tr>
                                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th>Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©</th>
                                <th>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            </tr>
                        </thead>
                        <tbody id="recentViolationsBody">
                            <tr>
                                <td colspan="4" class="empty-state">
                                    <i class="fas fa-clipboard-list"></i>
                                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø®Ø§Ù„ÙØ§Øª</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Vehicles Database -->
        <div class="card">
            <h2><i class="fas fa-database"></i> Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</h2>
            <div class="search-box">
                <input type="text" id="searchVehicles" placeholder="ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©ØŒ Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©ØŒ Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ...">
            </div>
            <div class="table-container">
                <table id="vehiclesTable">
                    <thead>
                        <tr>
                            <th>Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©</th>
                            <th>Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th>
                            <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ</th>
                            <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª</th>
                            <th>Ø¢Ø®Ø± Ù…Ø®Ø§Ù„ÙØ©</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        </tr>
                    </thead>
                    <tbody id="vehiclesBody">
                        <tr>
                            <td colspan="6" class="empty-state">
                                <i class="fas fa-car"></i>
                                <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³ÙŠØ§Ø±Ø§Øª Ù…Ø³Ø¬Ù„Ø©</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Loading State -->
        <div class="loading" id="loading">
            <i class="fas fa-spinner fa-spin" style="font-size: 48px;"></i>
            <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
        </div>
    </div>

    <script src="../js/database.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        // Ø¥Ø¯Ø§Ø±Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const db = new DatabaseManager();
        const auth = new AuthManager();

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        if (!auth.currentUser) {
            window.location.href = '../index.html';
        }

        // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª ÙˆØ§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª
        let vehiclesDatabase = [];
        let violationsDatabase = [];

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', function() {
            initializeData();
            loadAnalytics();
            setupEventListeners();
        });

        // ØªÙ‡ÙŠØ¦Ø© Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        function initializeData() {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            if (!localStorage.getItem('vehiclesDatabase')) {
                vehiclesDatabase = [];
                localStorage.setItem('vehiclesDatabase', JSON.stringify(vehiclesDatabase));
            } else {
                vehiclesDatabase = JSON.parse(localStorage.getItem('vehiclesDatabase'));
            }

            if (!localStorage.getItem('violations')) {
                violationsDatabase = [];
                localStorage.setItem('violations', JSON.stringify(violationsDatabase));
            } else {
                violationsDatabase = JSON.parse(localStorage.getItem('violations'));
            }

            // Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª
            syncVehiclesFromViolations();
        }

        // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ù…Ù† Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª
        function syncVehiclesFromViolations() {
            violationsDatabase.forEach(violation => {
                if (!vehiclesDatabase.find(v => v.plateNumber === violation.plateNumber)) {
                    const vehicleData = {
                        plateNumber: violation.plateNumber,
                        vehicleType: violation.vehicleType || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                        ownerName: violation.driverName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                        violationsCount: 0,
                        lastViolationDate: null,
                        status: 'Ù†Ø´Ø·',
                        createdDate: new Date().toISOString()
                    };
                    vehiclesDatabase.push(vehicleData);
                }
            });
            
            // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ù„ÙƒÙ„ Ø³ÙŠØ§Ø±Ø©
            vehiclesDatabase.forEach(vehicle => {
                const vehicleViolations = violationsDatabase.filter(v => v.plateNumber === vehicle.plateNumber);
                vehicle.violationsCount = vehicleViolations.length;
                
                if (vehicleViolations.length > 0) {
                    const sortedViolations = vehicleViolations.sort((a, b) => new Date(b.date) - new Date(a.date));
                    vehicle.lastViolationDate = sortedViolations[0].date;
                }
                
                // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª
                if (vehicle.violationsCount >= 5) {
                    vehicle.status = 'Ø®Ø·Ø±';
                } else if (vehicle.violationsCount >= 3) {
                    vehicle.status = 'ØªØ­Ø°ÙŠØ±';
                } else {
                    vehicle.status = 'Ù†Ø´Ø·';
                }
            });
            
            localStorage.setItem('vehiclesDatabase', JSON.stringify(vehiclesDatabase));
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª
        function loadAnalytics() {
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            const totalVehicles = vehiclesDatabase.length;
            const totalViolations = violationsDatabase.length;
            const repeatedOffenders = vehiclesDatabase.filter(v => v.violationsCount >= 2).length;
            const resolvedViolations = violationsDatabase.filter(v => v.status === 'Ù…Ø­Ù„ÙˆÙ„' || v.status === 'Ù…Ø¯ÙÙˆØ¹').length;

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ©
            document.getElementById('totalVehicles').textContent = totalVehicles;
            document.getElementById('totalViolations').textContent = totalViolations;
            document.getElementById('repeatedOffenders').textContent = repeatedOffenders;
            document.getElementById('resolvedViolations').textContent = resolvedViolations;

            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
            loadTopOffenders();
            loadRecentViolations();
            loadVehiclesTable();
        }

        // ØªØ­Ù…ÙŠÙ„ Ø£ÙƒØ«Ø± Ø§Ù„Ù…Ø®Ø§Ù„ÙÙŠÙ†
        function loadTopOffenders() {
            const topOffenders = vehiclesDatabase
                .filter(v => v.violationsCount > 0)
                .sort((a, b) => b.violationsCount - a.violationsCount)
                .slice(0, 10);

            const tbody = document.getElementById('topOffendersBody');
            
            if (topOffenders.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="empty-state">
                            <i class="fas fa-database"></i>
                            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø©</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = topOffenders.map((vehicle, index) => {
                let badgeClass = 'badge-info';
                if (vehicle.violationsCount >= 5) badgeClass = 'badge-danger';
                else if (vehicle.violationsCount >= 3) badgeClass = 'badge-warning';

                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td><strong>${vehicle.plateNumber}</strong></td>
                        <td><span class="violation-count">${vehicle.violationsCount}</span></td>
                        <td><span class="badge ${badgeClass}">${vehicle.status}</span></td>
                    </tr>
                `;
            }).join('');
        }

        // ØªØ­Ù…ÙŠÙ„ Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª
        function loadRecentViolations() {
            const recentViolations = [...violationsDatabase]
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 10);

            const tbody = document.getElementById('recentViolationsBody');
            
            if (recentViolations.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="empty-state">
                            <i class="fas fa-clipboard-list"></i>
                            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø®Ø§Ù„ÙØ§Øª</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = recentViolations.map(violation => {
                const statusBadge = getViolationStatusBadge(violation.status || 'Ø¬Ø¯ÙŠØ¯');
                return `
                    <tr>
                        <td>${formatDate(violation.date)}</td>
                        <td><strong>${violation.plateNumber}</strong></td>
                        <td>${violation.violationType || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
            }).join('');
        }

        // ØªØ­Ù…ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª
        function loadVehiclesTable() {
            const tbody = document.getElementById('vehiclesBody');
            
            if (vehiclesDatabase.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <i class="fas fa-car"></i>
                            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³ÙŠØ§Ø±Ø§Øª Ù…Ø³Ø¬Ù„Ø©</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = vehiclesDatabase.map(vehicle => {
                let statusBadge = 'badge-success';
                if (vehicle.status === 'Ø®Ø·Ø±') statusBadge = 'badge-danger';
                else if (vehicle.status === 'ØªØ­Ø°ÙŠØ±') statusBadge = 'badge-warning';

                return `
                    <tr>
                        <td><strong>${vehicle.plateNumber}</strong></td>
                        <td>${vehicle.vehicleType}</td>
                        <td>${vehicle.ownerName}</td>
                        <td><span class="violation-count">${vehicle.violationsCount}</span></td>
                        <td>${vehicle.lastViolationDate ? formatDate(vehicle.lastViolationDate) : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</td>
                        <td><span class="badge ${statusBadge}">${vehicle.status}</span></td>
                    </tr>
                `;
            }).join('');
        }

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
        function setupEventListeners() {
            // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø®Ø§Ù„ÙÙŠÙ†
            document.getElementById('searchOffenders').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                filterTopOffenders(searchTerm);
            });

            // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª
            document.getElementById('searchVehicles').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                filterVehicles(searchTerm);
            });

            // ØªØµÙÙŠØ© Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©
            document.getElementById('filterType').addEventListener('change', function() {
                filterViolations();
            });

            // ØªØµÙÙŠØ© Ø§Ù„ØªØ§Ø±ÙŠØ®
            document.getElementById('filterDate').addEventListener('change', function() {
                filterViolations();
            });
        }

        // ØªØµÙÙŠØ© Ø§Ù„Ù…Ø®Ø§Ù„ÙÙŠÙ†
        function filterTopOffenders(searchTerm) {
            const topOffenders = vehiclesDatabase
                .filter(v => v.violationsCount > 0 && v.plateNumber.toLowerCase().includes(searchTerm))
                .sort((a, b) => b.violationsCount - a.violationsCount)
                .slice(0, 10);

            const tbody = document.getElementById('topOffendersBody');
            
            if (topOffenders.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="empty-state">
                            <i class="fas fa-search"></i>
                            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = topOffenders.map((vehicle, index) => {
                let badgeClass = 'badge-info';
                if (vehicle.violationsCount >= 5) badgeClass = 'badge-danger';
                else if (vehicle.violationsCount >= 3) badgeClass = 'badge-warning';

                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td><strong>${vehicle.plateNumber}</strong></td>
                        <td><span class="violation-count">${vehicle.violationsCount}</span></td>
                        <td><span class="badge ${badgeClass}">${vehicle.status}</span></td>
                    </tr>
                `;
            }).join('');
        }

        // ØªØµÙÙŠØ© Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª
        function filterVehicles(searchTerm) {
            const filteredVehicles = vehiclesDatabase.filter(vehicle => 
                vehicle.plateNumber.toLowerCase().includes(searchTerm) ||
                vehicle.vehicleType.toLowerCase().includes(searchTerm) ||
                vehicle.ownerName.toLowerCase().includes(searchTerm)
            );

            const tbody = document.getElementById('vehiclesBody');
            
            if (filteredVehicles.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <i class="fas fa-search"></i>
                            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredVehicles.map(vehicle => {
                let statusBadge = 'badge-success';
                if (vehicle.status === 'Ø®Ø·Ø±') statusBadge = 'badge-danger';
                else if (vehicle.status === 'ØªØ­Ø°ÙŠØ±') statusBadge = 'badge-warning';

                return `
                    <tr>
                        <td><strong>${vehicle.plateNumber}</strong></td>
                        <td>${vehicle.vehicleType}</td>
                        <td>${vehicle.ownerName}</td>
                        <td><span class="violation-count">${vehicle.violationsCount}</span></td>
                        <td>${vehicle.lastViolationDate ? formatDate(vehicle.lastViolationDate) : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</td>
                        <td><span class="badge ${statusBadge}">${vehicle.status}</span></td>
                    </tr>
                `;
            }).join('');
        }

        // ØªØµÙÙŠØ© Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª
        function filterViolations() {
            const filterType = document.getElementById('filterType').value;
            const filterDate = document.getElementById('filterDate').value;

            let filteredViolations = [...violationsDatabase];

            if (filterType) {
                filteredViolations = filteredViolations.filter(v => v.violationType === filterType);
            }

            if (filterDate) {
                filteredViolations = filteredViolations.filter(v => v.date === filterDate);
            }

            const recentViolations = filteredViolations
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 10);

            const tbody = document.getElementById('recentViolationsBody');
            
            if (recentViolations.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="empty-state">
                            <i class="fas fa-filter"></i>
                            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„ØªØµÙÙŠØ©</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = recentViolations.map(violation => {
                const statusBadge = getViolationStatusBadge(violation.status || 'Ø¬Ø¯ÙŠØ¯');
                return `
                    <tr>
                        <td>${formatDate(violation.date)}</td>
                        <td><strong>${violation.plateNumber}</strong></td>
                        <td>${violation.violationType || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
            }).join('');
        }

        // ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø©
        function getViolationStatusBadge(status) {
            const statusMap = {
                'Ø¬Ø¯ÙŠØ¯': 'badge-info',
                'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©': 'badge-warning',
                'Ù…Ø­Ù„ÙˆÙ„': 'badge-success',
                'Ù…Ø¯ÙÙˆØ¹': 'badge-success',
                'Ù…Ù„ØºÙŠ': 'badge-secondary'
            };
            
            const badgeClass = statusMap[status] || 'badge-info';
            return `<span class="badge ${badgeClass}">${status}</span>`;
        }

        function formatDate(dateString) {
            if (!dateString) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            const date = new Date(dateString);
            return date.toLocaleDateString('ar-SA');
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
        setInterval(() => {
            initializeData();
            loadAnalytics();
        }, 30000);
    </script>
</body>
</html>
