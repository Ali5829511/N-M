<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù„ØµÙ‚Ø§Øª</title>
    <link rel="stylesheet" href="../css/responsive-style.css">
    <style>
        body {
            padding: 20px;
            background: #f5f5f5;
        }
        
        .import-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .import-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .import-header h1 {
            color: #2c5282;
            margin-bottom: 10px;
        }
        
        .import-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-box {
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-box.success {
            background: #f0fff4;
            border: 2px solid #38a169;
        }
        
        .stat-box.warning {
            background: #fffaf0;
            border: 2px solid #d69e2e;
        }
        
        .stat-box.danger {
            background: #fff5f5;
            border: 2px solid #e53e3e;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-danger {
            background: #e53e3e;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c53030;
        }
        
        .btn-success {
            background: #38a169;
            color: white;
        }
        
        .btn-success:hover {
            background: #2f855a;
        }
        
        .btn-primary {
            background: #3182ce;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2c5282;
        }
        
        .log-container {
            margin-top: 20px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 6px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .log-entry {
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .log-entry.success {
            background: #f0fff4;
            color: #22543d;
        }
        
        .log-entry.error {
            background: #fff5f5;
            color: #742a2a;
        }
        
        .log-entry.info {
            background: #ebf8ff;
            color: #2c5282;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #edf2f7;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #38a169, #48bb78);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="import-container">
        <div class="import-header">
            <h1>ğŸ”„ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Excel</h1>
            <p>Ø¥Ø¯Ø§Ø±Ø© Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØ­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„ØµÙ‚Ø§Øª</p>
        </div>
        
        <div class="import-stats">
            <div class="stat-box success">
                <div class="stat-value" id="currentCount">-</div>
                <div class="stat-label">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
            </div>
            <div class="stat-box warning">
                <div class="stat-value" id="newCount">2382</div>
                <div class="stat-label">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</div>
            </div>
            <div class="stat-box danger">
                <div class="stat-value" id="processedCount">0</div>
                <div class="stat-label">ØªÙ… Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</div>
            </div>
        </div>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progressBar" style="width: 0%">0%</div>
        </div>
        
        <div class="btn-group">
            <button class="btn btn-danger" onclick="deleteAllData()">ğŸ—‘ï¸ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            <button class="btn btn-success" onclick="importData()">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            <button class="btn btn-primary" onclick="viewData()">ğŸ‘ï¸ Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        </div>
        
        <div class="log-container" id="logContainer">
            <div class="log-entry info">Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¨Ø¯Ø¡...</div>
        </div>
    </div>

    <script src="../js/database.js"></script>
    <script>
        // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ù…Ù† JSON)
        let newStickersData = [];
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        async function loadNewData() {
            try {
                const response = await fetch('../data/stickers_data.json');
                newStickersData = await response.json();
                document.getElementById('newCount').textContent = newStickersData.length;
                addLog('success', `ØªÙ… ØªØ­Ù…ÙŠÙ„ ${newStickersData.length} Ù…Ù„ØµÙ‚ Ù…Ù† Ù…Ù„Ù JSON`);
            } catch (error) {
                addLog('error', 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message);
            }
        }
        
        // Ø¹Ø±Ø¶ Ø¹Ø¯Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        function updateCurrentCount() {
            const stickers = db.getAllStickers();
            document.getElementById('currentCount').textContent = stickers.length;
        }
        
        // Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        function deleteAllData() {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŸ\n\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!')) {
                return;
            }
            
            try {
                // Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage
                localStorage.removeItem('stickers');
                localStorage.removeItem('stickerStats');
                localStorage.removeItem('stickerHistory');
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª ÙØ§Ø±ØºØ©
                localStorage.setItem('stickers', JSON.stringify([]));
                
                addLog('success', 'âœ… ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
                updateCurrentCount();
                updateProgress(0);
                document.getElementById('processedCount').textContent = '0';
            } catch (error) {
                addLog('error', 'âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message);
            }
        }
        
        // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        async function importData() {
            if (newStickersData.length === 0) {
                addLog('error', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯. Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...');
                await loadNewData();
                if (newStickersData.length === 0) {
                    return;
                }
            }
            
            if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${newStickersData.length} Ù…Ù„ØµÙ‚ØŸ`)) {
                return;
            }
            
            addLog('info', 'Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯...');
            
            let imported = 0;
            let failed = 0;
            
            // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©
            try {
                const stickers = [];
                
                for (let i = 0; i < newStickersData.length; i++) {
                    const data = newStickersData[i];
                    
                    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†Ø¸Ø§Ù…
                    const sticker = {
                        id: data.id,
                        residentName: data.residentName,
                        nationalId: data.nationalId,
                        phoneNumber: '',
                        unitType: data.unitType === 'A' ? 'Ø´Ù‚Ø©' : data.unitType === 'V' ? 'ÙÙ„Ø©' : 'Ø´Ù‚Ø©',
                        building: data.building,
                        apartment: data.apartment,
                        licensePlate: data.licensePlate,
                        vehicleType: data.vehicleType,
                        vehicleMake: extractMake(data.vehicleType),
                        vehicleModel: extractModel(data.vehicleType),
                        vehicleColor: extractColor(data.vehicleType),
                        vehicleYear: extractYear(data.vehicleType),
                        status: data.status === 'active' ? 'ÙØ¹Ø§Ù„' : 'Ù…Ù„ØºÙŠ',
                        issueDate: data.issueDate,
                        expiryDate: calculateExpiryDate(data.issueDate),
                        deliveryStatus: 'Ù„Ø§ ÙŠÙˆØ¬Ø¯',
                        notes: ''
                    };
                    
                    stickers.push(sticker);
                    imported++;
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø¯Ù… ÙƒÙ„ 100 Ù…Ù„ØµÙ‚
                    if (i % 100 === 0) {
                        updateProgress((i / newStickersData.length) * 100);
                        document.getElementById('processedCount').textContent = imported;
                        await new Promise(resolve => setTimeout(resolve, 10));
                    }
                }
                
                // Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                localStorage.setItem('stickers', JSON.stringify(stickers));
                
                updateProgress(100);
                document.getElementById('processedCount').textContent = imported;
                addLog('success', `âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${imported} Ù…Ù„ØµÙ‚ Ø¨Ù†Ø¬Ø§Ø­`);
                updateCurrentCount();
                
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                updateStats(stickers);
                
            } catch (error) {
                addLog('error', `âŒ ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: ${error.message}`);
            }
        }
        
        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù…Ù† Ù†Øµ "Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©"
        function extractMake(vehicleType) {
            const parts = vehicleType.split(' ');
            return parts[0] || '';
        }
        
        function extractModel(vehicleType) {
            const parts = vehicleType.split(' ');
            return parts.slice(1, -2).join(' ') || '';
        }
        
        function extractColor(vehicleType) {
            const parts = vehicleType.split(' ');
            return parts[parts.length - 2] || '';
        }
        
        function extractYear(vehicleType) {
            const parts = vehicleType.split(' ');
            const lastPart = parts[parts.length - 1];
            return lastPart && /^\d{4}$/.test(lastPart) ? lastPart : '';
        }
        
        // Ø­Ø³Ø§Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ (Ø³Ù†Ø© ÙˆØ§Ø­Ø¯Ø© Ù…Ù† ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±)
        function calculateExpiryDate(issueDate) {
            if (!issueDate) return '';
            const date = new Date(issueDate);
            date.setFullYear(date.getFullYear() + 1);
            return date.toISOString().split('T')[0];
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        function updateStats(stickers) {
            const stats = {
                total: stickers.length,
                active: stickers.filter(s => s.status === 'ÙØ¹Ø§Ù„').length,
                inactive: stickers.filter(s => s.status === 'ØºÙŠØ± ÙØ¹Ø§Ù„').length,
                cancelled: stickers.filter(s => s.status === 'Ù…Ù„ØºÙŠ').length,
                violations: 0,
                todayIssued: 0,
                weekIssued: 0
            };
            
            localStorage.setItem('stickerStats', JSON.stringify(stats));
            addLog('info', `ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª: ÙØ¹Ø§Ù„: ${stats.active}, Ù…Ù„ØºÙŠ: ${stats.cancelled}`);
        }
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        function viewData() {
            window.location.href = 'enhanced_stickers_management.html';
        }
        
        // Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„
        function addLog(type, message) {
            const logContainer = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const time = new Date().toLocaleTimeString('ar-SA');
            entry.textContent = `[${time}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
        function updateProgress(percent) {
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = percent + '%';
            progressBar.textContent = Math.round(percent) + '%';
        }
        
        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('load', () => {
            updateCurrentCount();
            loadNewData();
        });
    </script>
</body>
</html>
