<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إعدادات النظام - وحدة إسكان هيئة التدريس</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #8B6F47;
            --secondary-color: #A0826D;
            --accent-color: #C9B896;
            --light-bg: #f8f5f0;
            --success-color: #51cf66;
            --error-color: #ff6b6b;
            --text-dark: #2c3e50;
            --text-light: #7f8c8d;
            --border-radius: 16px;
            --shadow-sm: 0 2px 8px rgba(139, 111, 71, 0.08);
            --shadow-md: 0 8px 24px rgba(139, 111, 71, 0.12);
            --shadow-lg: 0 16px 48px rgba(139, 111, 71, 0.16);
        }

        body {
            font-family: 'Tajawal', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #f8f5f0 0%, #e8dcc8 100%);
            min-height: 100vh;
            direction: rtl;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* الترويسة */
        .header {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            object-fit: contain;
            background: white;
            padding: 8px;
            box-shadow: var(--shadow-md);
        }

        .header-text h1 {
            font-size: clamp(22px, 4vw, 28px);
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .header-text p {
            color: var(--text-light);
            font-size: clamp(13px, 2vw, 15px);
        }

        .back-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
            text-decoration: none;
        }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* التبويبات */
        .tabs-container {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-lg);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            border-bottom: 2px solid #e8ecf1;
            padding-bottom: 10px;
        }

        .tab-btn {
            background: transparent;
            border: none;
            color: var(--text-light);
            padding: 15px 25px;
            border-radius: 12px 12px 0 0;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }

        .tab-btn:hover {
            background: rgba(139, 111, 71, 0.1);
            color: var(--primary-color);
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 12px;
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -12px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid var(--secondary-color);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* أقسام المحتوى */
        .content-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-description {
            color: var(--text-light);
            font-size: 14px;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        /* نماذج الإدخال */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-dark);
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input[type="text"],
        .form-group input[type="email"] {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e8ecf1;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s ease;
            font-family: 'Tajawal', sans-serif;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 4px rgba(139, 111, 71, 0.1);
        }

        .form-group .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
        }

        .form-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        /* الأزرار */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: #e8ecf1;
            color: var(--text-dark);
        }

        .btn-secondary:hover {
            background: #d1d5db;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #40c057);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--error-color), #ee5a52);
            color: white;
        }

        /* جدول البيانات */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table thead {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: center;
            border-bottom: 1px solid #e8ecf1;
        }

        .data-table th {
            font-weight: 600;
            font-size: 14px;
        }

        .data-table tbody tr:hover {
            background: #f8f9fa;
        }

        /* بطاقات الإحصائيات */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--shadow-sm);
            text-align: center;
            border: 2px solid #e8ecf1;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
            border-color: var(--accent-color);
        }

        .stat-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .stat-number {
            font-size: 2em;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--text-light);
            font-size: 14px;
        }

        /* شارات الحالة */
        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-warning {
            background: #fed7aa;
            color: #92400e;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        /* رسائل التنبيه */
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border-right: 4px solid #3b82f6;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-right: 4px solid #10b981;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border-right: 4px solid #f59e0b;
        }

        /* تصميم متجاوب */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }

            .header-content {
                flex-direction: column;
            }

            .tabs {
                flex-direction: column;
            }

            .tab-btn {
                width: 100%;
                justify-content: center;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* محمل التحميل */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        .loading i {
            font-size: 3em;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: var(--text-light);
            font-size: 14px;
            margin-top: 30px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- الترويسة -->
        <div class="header">
            <div class="header-content">
                <img src="شعار.jpg" alt="شعار جامعة الإمام محمد بن سعود الإسلامية" class="logo">
                <div class="header-text">
                    <h1>إعدادات النظام</h1>
                    <p>إدارة المستخدمين • قاعدة البيانات • البريد الإلكتروني</p>
                </div>
            </div>
            <a href="main_dashboard.html" class="back-btn">
                <i class="fas fa-arrow-right"></i>
                العودة للرئيسية
            </a>
        </div>

        <!-- حاوية التبويبات -->
        <div class="tabs-container">
            <!-- التبويبات -->
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('users')">
                    <i class="fas fa-users-cog"></i>
                    إدارة المستخدمين
                </button>
                <button class="tab-btn" onclick="switchTab('database')">
                    <i class="fas fa-database"></i>
                    قاعدة البيانات
                </button>
                <button class="tab-btn" onclick="switchTab('email')">
                    <i class="fas fa-envelope"></i>
                    إعدادات البريد
                </button>
            </div>

            <!-- محتوى تبويب إدارة المستخدمين -->
            <div id="users-tab" class="tab-content active">
                <div class="content-section">
                    <h2 class="section-title">
                        <i class="fas fa-users"></i>
                        إدارة المستخدمين
                    </h2>
                    <p class="section-description">
                        إدارة حسابات المستخدمين والصلاحيات في النظام
                    </p>

                    <!-- إحصائيات المستخدمين -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon" style="color: #10b981;">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-number" id="totalUsers">0</div>
                            <div class="stat-label">إجمالي المستخدمين</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="color: #3b82f6;">
                                <i class="fas fa-user-shield"></i>
                            </div>
                            <div class="stat-number" id="adminUsers">0</div>
                            <div class="stat-label">المدراء</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="color: #f59e0b;">
                                <i class="fas fa-user-edit"></i>
                            </div>
                            <div class="stat-number" id="entryUsers">0</div>
                            <div class="stat-label">مسجلي المخالفات</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="color: #8b5cf6;">
                                <i class="fas fa-user-check"></i>
                            </div>
                            <div class="stat-number" id="activeUsers">0</div>
                            <div class="stat-label">المستخدمين النشطين</div>
                        </div>
                    </div>

                    <!-- زر إضافة مستخدم -->
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="showAddUserForm()">
                            <i class="fas fa-plus"></i>
                            إضافة مستخدم جديد
                        </button>
                    </div>

                    <!-- جدول المستخدمين -->
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>الاسم</th>
                                    <th>اسم المستخدم</th>
                                    <th>البريد الإلكتروني</th>
                                    <th>الدور</th>
                                    <th>الحالة</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <tr>
                                    <td colspan="6" class="loading">
                                        <i class="fas fa-spinner"></i>
                                        <p>جاري تحميل البيانات...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- محتوى تبويب قاعدة البيانات -->
            <div id="database-tab" class="tab-content">
                <div class="content-section">
                    <h2 class="section-title">
                        <i class="fas fa-database"></i>
                        حالة قاعدة البيانات
                    </h2>
                    <p class="section-description">
                        مراقبة وإحصائيات قاعدة البيانات
                    </p>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <span>النظام يستخدم قاعدة بيانات محلية (LocalStorage) للتخزين</span>
                    </div>

                    <!-- إحصائيات قاعدة البيانات -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon" style="color: #f59e0b;">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="stat-number" id="totalViolations">0</div>
                            <div class="stat-label">المخالفات</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="color: #3b82f6;">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="stat-number" id="totalStickers">0</div>
                            <div class="stat-label">الملصقات</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="color: #10b981;">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-number" id="totalResidents">0</div>
                            <div class="stat-label">السكان</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="color: #8b5cf6;">
                                <i class="fas fa-building"></i>
                            </div>
                            <div class="stat-number" id="totalApartments">0</div>
                            <div class="stat-label">الوحدات السكنية</div>
                        </div>
                    </div>

                    <!-- معلومات التخزين -->
                    <div class="content-section">
                        <h3 class="section-title">
                            <i class="fas fa-hdd"></i>
                            معلومات التخزين
                        </h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>البيان</th>
                                    <th>القيمة</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>نوع التخزين</td>
                                    <td><span class="badge badge-success">LocalStorage</span></td>
                                </tr>
                                <tr>
                                    <td>حالة الاتصال</td>
                                    <td><span class="badge badge-success" id="dbStatus">متصل</span></td>
                                </tr>
                                <tr>
                                    <td>عدد الجداول</td>
                                    <td id="tablesCount">-</td>
                                </tr>
                                <tr>
                                    <td>حجم البيانات (تقريبي)</td>
                                    <td id="dataSize">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- أزرار الإجراءات -->
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="refreshDatabaseStats()">
                            <i class="fas fa-sync"></i>
                            تحديث البيانات
                        </button>
                        <button class="btn btn-secondary" onclick="exportData()">
                            <i class="fas fa-download"></i>
                            تصدير البيانات
                        </button>
                    </div>
                </div>
            </div>

            <!-- محتوى تبويب إعدادات البريد -->
            <div id="email-tab" class="tab-content">
                <div class="content-section">
                    <h2 class="section-title">
                        <i class="fas fa-envelope-open-text"></i>
                        إعدادات البريد الإلكتروني
                    </h2>
                    <p class="section-description">
                        إدارة وتكوين خدمة إرسال الإشعارات عبر البريد الإلكتروني
                    </p>

                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>يجب إنشاء حساب على <a href="https://www.emailjs.com" target="_blank" style="color: inherit; font-weight: bold;">EmailJS</a> لتفعيل خدمة البريد الإلكتروني</span>
                    </div>

                    <!-- حالة الخدمة -->
                    <div class="content-section">
                        <h3 class="section-title">حالة الخدمة</h3>
                        <div class="stat-card">
                            <div class="stat-icon" style="color: #ef4444;">
                                <i class="fas fa-times-circle"></i>
                            </div>
                            <div class="stat-label">غير مفعلة</div>
                        </div>
                    </div>

                    <!-- تفعيل الخدمة -->
                    <div class="content-section">
                        <h3 class="section-title">التحكم في الخدمة</h3>
                        <div class="form-group">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="emailServiceEnabled">
                                <label for="emailServiceEnabled">تفعيل خدمة البريد الإلكتروني</label>
                            </div>
                        </div>
                    </div>

                    <!-- تكوين EmailJS -->
                    <div class="content-section">
                        <h3 class="section-title">تكوين EmailJS</h3>
                        <div class="form-group">
                            <label for="serviceId">معرف الخدمة (Service ID) *</label>
                            <input type="text" id="serviceId" placeholder="مثال: service_abc123" value="service_default">
                        </div>
                        <div class="form-group">
                            <label for="publicKey">المفتاح العام (Public Key) *</label>
                            <input type="text" id="publicKey" placeholder="مثال: user_xyz789">
                        </div>
                        <div class="form-group">
                            <label for="adminEmail">البريد الإلكتروني للإدارة</label>
                            <input type="email" id="adminEmail" placeholder="admin@university.edu.sa" value="admin@university.edu.sa">
                        </div>
                    </div>

                    <!-- إعدادات الإشعارات -->
                    <div class="content-section">
                        <h3 class="section-title">إعدادات الإشعارات</h3>
                        <div class="form-group">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="notifyNewUser" checked>
                                <label for="notifyNewUser">إرسال إشعار عند إنشاء مستخدم جديد</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="notifyNewViolation" checked>
                                <label for="notifyNewViolation">إرسال إشعار عند تسجيل مخالفة جديدة</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="notifyPasswordReset" checked>
                                <label for="notifyPasswordReset">إرسال إشعار عند إعادة تعيين كلمة المرور</label>
                            </div>
                        </div>
                    </div>

                    <!-- أزرار الحفظ -->
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="saveEmailSettings()">
                            <i class="fas fa-save"></i>
                            حفظ الإعدادات
                        </button>
                        <button class="btn btn-secondary" onclick="testEmailService()">
                            <i class="fas fa-paper-plane"></i>
                            اختبار الخدمة
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- التذييل -->
        <div class="footer">
            <p>جميع الحقوق محفوظة © جامعة الإمام محمد بن سعود الإسلامية 2025</p>
        </div>
    </div>

    <!-- تحميل مكتبات النظام -->
    <script src="js/database.js"></script>
    <script src="js/auth.js"></script>
    
    <script>
        'use strict';
        
        // حماية الصفحة - السماح فقط للمدراء
        if (!window.authManager.requireAuth(['admin'])) {
            // سيتم إعادة التوجيه تلقائياً
        }

        // تبديل التبويبات
        function switchTab(tabName) {
            // إخفاء جميع التبويبات
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // إظهار التبويب المحدد
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.closest('.tab-btn').classList.add('active');

            // تحميل البيانات حسب التبويب
            if (tabName === 'users') {
                loadUsersData();
            } else if (tabName === 'database') {
                loadDatabaseStats();
            } else if (tabName === 'email') {
                loadEmailSettings();
            }
        }

        // تحميل بيانات المستخدمين
        async function loadUsersData() {
            try {
                const users = await window.db.getUsers();
                const stats = await window.db.getUserStats();
                
                // تحديث الإحصائيات
                document.getElementById('totalUsers').textContent = stats.total || 0;
                document.getElementById('adminUsers').textContent = stats.admins || 0;
                document.getElementById('entryUsers').textContent = stats.violationOfficers || 0;
                document.getElementById('activeUsers').textContent = stats.active || 0;
                
                // تحديث الجدول
                const tbody = document.getElementById('usersTableBody');
                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6">لا توجد مستخدمين</td></tr>';
                    return;
                }
                
                tbody.innerHTML = users.map(user => `
                    <tr>
                        <td>${user.name}</td>
                        <td>${user.username}</td>
                        <td>${user.email || '-'}</td>
                        <td><span class="badge badge-${user.role === 'admin' ? 'success' : 'warning'}">${user.role === 'admin' ? 'مدير' : user.role === 'violation_entry' ? 'مسجل مخالفات' : 'استعلام'}</span></td>
                        <td><span class="badge badge-${user.status === 'active' ? 'success' : 'danger'}">${user.status === 'active' ? 'نشط' : 'غير نشط'}</span></td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('خطأ في تحميل المستخدمين:', error);
            }
        }

        // تحميل إحصائيات قاعدة البيانات
        async function loadDatabaseStats() {
            try {
                const violations = await window.db.getViolations();
                const stickers = await window.db.getStickers();
                const residents = await window.db.getResidents();
                const apartments = await window.db.getApartments();
                
                document.getElementById('totalViolations').textContent = violations.length;
                document.getElementById('totalStickers').textContent = stickers.length;
                document.getElementById('totalResidents').textContent = residents.length;
                document.getElementById('totalApartments').textContent = apartments.length;
                
                // حساب حجم البيانات
                const dataSize = new Blob([localStorage.getItem('trafficDB') || '']).size;
                document.getElementById('dataSize').textContent = (dataSize / 1024).toFixed(2) + ' KB';
                document.getElementById('tablesCount').textContent = '8 جداول';
            } catch (error) {
                console.error('خطأ في تحميل إحصائيات قاعدة البيانات:', error);
            }
        }

        // تحميل إعدادات البريد
        function loadEmailSettings() {
            const settings = JSON.parse(localStorage.getItem('emailSettings') || '{}');
            document.getElementById('emailServiceEnabled').checked = settings.enabled || false;
            document.getElementById('serviceId').value = settings.serviceId || 'service_default';
            document.getElementById('publicKey').value = settings.publicKey || '';
            document.getElementById('adminEmail').value = settings.adminEmail || 'admin@university.edu.sa';
            document.getElementById('notifyNewUser').checked = settings.notifyNewUser !== false;
            document.getElementById('notifyNewViolation').checked = settings.notifyNewViolation !== false;
            document.getElementById('notifyPasswordReset').checked = settings.notifyPasswordReset !== false;
        }

        // حفظ إعدادات البريد
        function saveEmailSettings() {
            const settings = {
                enabled: document.getElementById('emailServiceEnabled').checked,
                serviceId: document.getElementById('serviceId').value,
                publicKey: document.getElementById('publicKey').value,
                adminEmail: document.getElementById('adminEmail').value,
                notifyNewUser: document.getElementById('notifyNewUser').checked,
                notifyNewViolation: document.getElementById('notifyNewViolation').checked,
                notifyPasswordReset: document.getElementById('notifyPasswordReset').checked
            };
            
            localStorage.setItem('emailSettings', JSON.stringify(settings));
            alert('تم حفظ الإعدادات بنجاح');
        }

        // اختبار خدمة البريد
        function testEmailService() {
            alert('سيتم إرسال بريد تجريبي...');
        }

        // تحديث إحصائيات قاعدة البيانات
        function refreshDatabaseStats() {
            loadDatabaseStats();
            alert('تم تحديث البيانات');
        }

        // تصدير البيانات
        function exportData() {
            const data = localStorage.getItem('trafficDB');
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        // إضافة مستخدم جديد
        function showAddUserForm() {
            alert('سيتم فتح نموذج إضافة مستخدم جديد');
        }

        // تحميل البيانات عند فتح الصفحة
        window.addEventListener('DOMContentLoaded', () => {
            loadUsersData();
        });
    </script>
</body>
</html>
